{% extends 'base.html' %}

{% block title %}AIèŠå¤© - ä¸­åŒ»è¯é—®ç­”ç³»ç»Ÿ{% endblock %}

{% block page_title %}ä¸­åŒ»è¯é—®ç­”ç§‘æ™®åŠ©æ‰‹{% endblock %}

{% block styles %}
<!-- Markdownæ¸²æŸ“å’Œä»£ç é«˜äº®CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
<style>
    .chat-container {
        height: calc(100vh - 250px);
        min-height: 500px;
        max-height: calc(100vh - 250px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .chat-sidebar {
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }
    
    /* ä¾§è¾¹æ æ»šåŠ¨æ¡æ ·å¼ */
    .chat-sidebar::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-sidebar::-webkit-scrollbar-track {
        background: #f8f9fa;
    }
    
    .chat-sidebar::-webkit-scrollbar-thumb {
        background: #dee2e6;
        border-radius: 3px;
    }
    
    .chat-sidebar::-webkit-scrollbar-thumb:hover {
        background: #c1c1c1;
    }
    .chat-history {
        overflow-y: auto;
        padding: 20px;
        background-color: #f9f9f9;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        min-height: 0;
    }
    
    .chat-input {
        margin-top: 20px;
    }
    
    .chat-input .form-control {
        border-radius: 25px;
        padding: 12px 20px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }
    
    .chat-input .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
        transform: translateY(-1px);
    }
    
    .chat-input .btn {
        border-radius: 25px;
        padding: 12px 24px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .chat-input .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    .chat-message {
        margin-bottom: 15px;
        max-width: 80%;
    }
    .user-message {
        margin-left: auto;
        background-color: #dcf8c6;
        border-radius: 10px 0 10px 10px;
        padding: 10px 15px;
    }
    .assistant-message {
        margin-right: auto;
        background-color: white;
        border-radius: 0 10px 10px 10px;
        padding: 10px 15px;
        border: 1px solid #e9ecef;
    }
    .message-time {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 5px;
        text-align: right;
    }
    .conversation-item {
        cursor: pointer;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        transition: background-color 0.2s;
    }
    .conversation-item:hover {
        background-color: #e9ecef;
    }
    .conversation-item.active {
        background-color: #e9ecef;
        border-left: 3px solid #007bff;
    }
    .conversation-title {
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .conversation-date {
        font-size: 0.7rem;
        color: #6c757d;
    }
    .sidebar-header {
        padding: 15px;
        font-weight: bold;
        border-bottom: 1px solid #dee2e6;
    }
    .create-chat-btn {
        margin: 15px;
    }
    
    /* Markdownæ ·å¼ */
    .message-content h1, .message-content h2, .message-content h3, 
    .message-content h4, .message-content h5, .message-content h6 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .message-content h1 { font-size: 1.5rem; }
    .message-content h2 { font-size: 1.3rem; }
    .message-content h3 { font-size: 1.1rem; }
    .message-content h4 { font-size: 1rem; }
    
    .message-content p {
        margin-bottom: 0.8rem;
        line-height: 1.5;
    }
    
    .message-content ul, .message-content ol {
        margin-bottom: 0.8rem;
        padding-left: 1.5rem;
    }
    
    .message-content li {
        margin-bottom: 0.3rem;
    }
    
    .message-content blockquote {
        border-left: 4px solid #ddd;
        margin: 0.8rem 0;
        padding-left: 1rem;
        color: #666;
        font-style: italic;
    }
    
    .message-content code {
        background-color: #f4f4f4;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    
    .message-content pre {
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
        overflow-x: auto;
        overflow-y: auto;
        max-height: 300px;
        margin: 0.8rem 0;
    }
    
    .message-content pre code {
        background-color: transparent;
        padding: 0;
        border-radius: 0;
    }
    
    .message-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 0.8rem 0;
    }
    
    .message-content th, .message-content td {
        border: 1px solid #ddd;
        padding: 0.5rem;
        text-align: left;
    }
    
    .message-content th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    
    .message-content strong {
        font-weight: bold;
    }
    
    .message-content em {
        font-style: italic;
    }
    
    .message-content a {
        color: #007bff;
        text-decoration: none;
    }
    
    .message-content a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <p class="text-muted"></p>
    </div>
</div>

<div class="row chat-container">
    <!-- å¯¹è¯å†å²ä¾§è¾¹æ  -->
    <div class="col-md-3 chat-sidebar">
        <div class="sidebar-header">
            å†å²å¯¹è¯
        </div>
        <div class="d-grid gap-2 create-chat-btn">
            <button id="new-chat-btn" class="btn btn-primary">
                æ–°å»ºå¯¹è¯
            </button>
        </div>
        <div id="conversation-list">
            <!-- å¯¹è¯å†å²åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
            <div class="text-center text-muted p-3" id="no-conversations-message">
                æš‚æ— èŠå¤©è®°å½•
            </div>
        </div>
    </div>
    
    <!-- èŠå¤©ä¸»ç•Œé¢ -->
    <div class="col-md-9 d-flex flex-column h-100">
        <div class="chat-history flex-grow-1" id="chat-history">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="chat-message assistant-message">
                <div class="message-content">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯ä¸­è‰è¯çŸ¥è¯†ç§‘æ™®çš„AIåŠ©æ‰‹ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„ï¼Ÿ
                </div>
                <div class="message-time">åˆšåˆš</div>
            </div>
        </div>
        
        <!-- è¾“å…¥æ¡† -->
        <div class="chat-input flex-shrink-0">
            <form id="chat-form" class="d-flex align-items-end">
                <div class="input-group flex-grow-1">
                    <button type="button" id="image-upload-btn" class="btn btn-outline-secondary" title="ä¸Šä¼ ä¸­è‰è¯å›¾ç‰‡">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    <input type="text" id="message-input" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯æˆ–ä¸Šä¼ ä¸­è‰è¯å›¾ç‰‡è¿›è¡Œè¯†åˆ«..." autofocus>
                    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                </div>
                <button type="submit" class="btn btn-primary ms-2">
                    å‘é€
                </button>
            </form>
            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div id="image-preview-container" class="mt-2" style="display: none;">
                <div class="image-preview-wrapper position-relative d-inline-block">
                    <img id="image-preview" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                    <button type="button" id="remove-image-btn" class="btn btn-sm btn-danger position-absolute top-0 end-0 rounded-circle" style="width: 25px; height: 25px; padding: 0; margin: 5px;">
                        <i class="bi bi-x" style="font-size: 12px;"></i>
                    </button>
                </div>
                <div class="mt-1">
                    <small class="text-muted">ç‚¹å‡»å‘é€è¿›è¡Œä¸­è‰è¯è¯†åˆ«</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Markdownæ¸²æŸ“å’Œä»£ç é«˜äº®åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
<script>
    // é…ç½®markedå’Œhighlight.js
    marked.setOptions({
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true
    });

    document.addEventListener('DOMContentLoaded', function() {
        // è·å–DOMå…ƒç´ 
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatHistory = document.getElementById('chat-history');
        const newChatBtn = document.getElementById('new-chat-btn');
        const conversationList = document.getElementById('conversation-list');
        const noConversationsMessage = document.getElementById('no-conversations-message');
        const imageUploadBtn = document.getElementById('image-upload-btn');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        
        // å½“å‰å¯¹è¯IDå’Œä¸Šä¼ çš„å›¾ç‰‡
        let currentConversationId = null;
        let uploadedImage = null;
        
        // åŠ è½½å¯¹è¯åˆ—è¡¨
        loadConversations();
        
        // æ–°å»ºå¯¹è¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        newChatBtn.addEventListener('click', function() {
            createNewConversation();
        });
        
        // å›¾ç‰‡ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        imageUploadBtn.addEventListener('click', function() {
            imageUploadInput.click();
        });
        
        // å›¾ç‰‡é€‰æ‹©äº‹ä»¶
        imageUploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
                    return;
                }
                
                uploadedImage = file;
                
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // ç§»é™¤å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        removeImageBtn.addEventListener('click', function() {
            uploadedImage = null;
            imagePreviewContainer.style.display = 'none';
            imageUploadInput.value = '';
        });
        
        // è¡¨å•æäº¤äº‹ä»¶
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯æˆ–å›¾ç‰‡
            if (message || uploadedImage) {
                // ç”Ÿæˆæ–°çš„å¯¹è¯IDï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (!currentConversationId) {
                    currentConversationId = `conv_${Date.now()}`;
                }
                
                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œè¿›è¡Œå›¾ç‰‡è¯†åˆ«
                if (uploadedImage) {
                    handleImageUpload(message || 'è¯·è¯†åˆ«è¿™å¼ ä¸­è‰è¯å›¾ç‰‡', currentConversationId);
                } else {
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
                    addMessage(message, 'user');
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    messageInput.value = '';
                    
                    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                    sendMessage(message, currentConversationId);
                }
            }
        });
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ å’Œè¯†åˆ«
        function handleImageUpload(message, conversationId) {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆåŒ…å«å›¾ç‰‡é¢„è§ˆï¼‰
            addImageMessage(message, uploadedImage, 'user');
            
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œå›¾ç‰‡
            messageInput.value = '';
            const imageFile = uploadedImage;
            uploadedImage = null;
            imagePreviewContainer.style.display = 'none';
            imageUploadInput.value = '';
            
            // åˆ›å»ºFormDataè¿›è¡Œå›¾ç‰‡ä¸Šä¼ 
            const formData = new FormData();
            formData.append('file', imageFile);
            
            // æ˜¾ç¤ºå¤„ç†ä¸­çš„æ¶ˆæ¯
            const processingMessageDiv = document.createElement('div');
            processingMessageDiv.className = 'chat-message assistant-message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = 'æ­£åœ¨è¯†åˆ«ä¸­è‰è¯å›¾ç‰‡ï¼Œè¯·ç¨å€™...';
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.innerText = 'æ­£åœ¨å¤„ç†...';
            
            processingMessageDiv.appendChild(messageContent);
            processingMessageDiv.appendChild(messageTime);
            chatHistory.appendChild(processingMessageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // è°ƒç”¨YOLOæ£€æµ‹API
            fetch('/api/detect/image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ£€æµ‹æˆåŠŸï¼Œæ„å»ºåŒ…å«æ£€æµ‹ç»“æœçš„æ¶ˆæ¯
                    let detectionMessage = `æˆ‘ä¸Šä¼ äº†ä¸€å¼ ä¸­è‰è¯å›¾ç‰‡ï¼Œè¯·å¸®æˆ‘åˆ†æè¯†åˆ«ç»“æœï¼š\n\n`;
                    detectionMessage += `æ£€æµ‹åˆ° ${data.detections.length} ä¸ªä¸­è‰è¯å¯¹è±¡ï¼š\n`;
                    
                    data.detections.forEach((detection, index) => {
                        detectionMessage += `${index + 1}. ${detection.class_name} (ç½®ä¿¡åº¦: ${(detection.confidence * 100).toFixed(1)}%)\n`;
                    });
                    
                    detectionMessage += `\nè¯·è¯¦ç»†ä»‹ç»è¿™äº›ä¸­è‰è¯çš„åŠŸæ•ˆã€ç”¨æ³•å’Œæ³¨æ„äº‹é¡¹ã€‚`;
                    
                    // ç§»é™¤å¤„ç†ä¸­çš„æ¶ˆæ¯
                    chatHistory.removeChild(processingMessageDiv);
                    
                    // æ·»åŠ æ£€æµ‹ç»“æœå›¾ç‰‡åˆ°èŠå¤©è®°å½•
                    addDetectionResultMessage(data, 'assistant');
                    
                    // å‘é€æ£€æµ‹ç»“æœç»™LLMè¿›è¡Œè§£é‡Š
                    sendMessage(detectionMessage, conversationId);
                } else {
                    // æ£€æµ‹å¤±è´¥
                    messageContent.innerHTML = `å›¾ç‰‡è¯†åˆ«å¤±è´¥: ${data.error}`;
                    messageTime.innerText = 'åˆšåˆš';
                }
            })
            .catch(error => {
                console.error('å›¾ç‰‡è¯†åˆ«å¤±è´¥:', error);
                messageContent.innerHTML = 'æŠ±æ­‰ï¼Œå›¾ç‰‡è¯†åˆ«è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                messageTime.innerText = 'åˆšåˆš';
            });
        }
        
        // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
        function sendMessage(message, conversationId) {
            // åˆ›å»ºä¸€ä¸ªç©ºçš„åŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
            const assistantMessageDiv = document.createElement('div');
            assistantMessageDiv.className = 'chat-message assistant-message';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.innerText = 'æ­£åœ¨è¾“å…¥...';
            
            assistantMessageDiv.appendChild(messageContent);
            assistantMessageDiv.appendChild(messageTime);
            chatHistory.appendChild(assistantMessageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // ä½¿ç”¨fetchè¿›è¡Œæµå¼æ¥æ”¶
            fetch('/api/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: conversationId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            messageTime.innerText = 'åˆšåˆš';
                            loadConversations();
                            return;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.error) {
                                        messageContent.innerText = 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯: ' + data.error;
                                        messageTime.innerText = 'åˆšåˆš';
                                        return;
                                    }
                                    
                                    if (data.chunk) {
                                        fullResponse += data.chunk;
                                        // å®æ—¶æ¸²æŸ“Markdown
                                        messageContent.innerHTML = marked.parse(fullResponse);
                                        // é«˜äº®ä»£ç å—
                                        messageContent.querySelectorAll('pre code').forEach((block) => {
                                            hljs.highlightElement(block);
                                        });
                                        // æ»šåŠ¨åˆ°åº•éƒ¨
                                        chatHistory.scrollTop = chatHistory.scrollHeight;
                                    }
                                    
                                    if (data.done) {
                                        messageTime.innerText = 'åˆšåˆš';
                                        currentConversationId = data.conversation_id;
                                        loadConversations();
                                        return;
                                    }
                                } catch (e) {
                                    // å¿½ç•¥è§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
                                }
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                console.error('æµå¼è¯·æ±‚å¤±è´¥:', error);
                messageContent.innerText = 'æŠ±æ­‰ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                messageTime.innerText = 'åˆšåˆš';
            });
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // æ ¹æ®è§’è‰²å†³å®šæ˜¯å¦æ¸²æŸ“Markdown
            if (role === 'assistant') {
                // AIå›å¤ä½¿ç”¨Markdownæ¸²æŸ“
                messageContent.innerHTML = marked.parse(content);
                // é«˜äº®ä»£ç å—
                messageContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                // ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨çº¯æ–‡æœ¬
                messageContent.innerText = content;
            }
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.innerText = 'åˆšåˆš';
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);
            
            chatHistory.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // æ·»åŠ å¸¦å›¾ç‰‡çš„æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
        function addImageMessage(content, imageFile, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // æ·»åŠ æ–‡æœ¬å†…å®¹
            const textDiv = document.createElement('div');
            textDiv.innerText = content;
            messageContent.appendChild(textDiv);
            
            // æ·»åŠ å›¾ç‰‡é¢„è§ˆ
            if (imageFile) {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'mt-2';
                
                const img = document.createElement('img');
                img.className = 'img-thumbnail';
                img.style.maxWidth = '300px';
                img.style.maxHeight = '200px';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(imageFile);
                
                imageDiv.appendChild(img);
                messageContent.appendChild(imageDiv);
            }
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.innerText = 'åˆšåˆš';
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // æ·»åŠ æ£€æµ‹ç»“æœæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
        function addDetectionResultMessage(detectionData, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // æ·»åŠ æ£€æµ‹ç»“æœæ ‡é¢˜
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = '<strong>ğŸ” ä¸­è‰è¯è¯†åˆ«ç»“æœ</strong>';
            titleDiv.className = 'mb-2';
            messageContent.appendChild(titleDiv);
            
            // æ·»åŠ æ£€æµ‹ç»“æœå›¾ç‰‡
            if (detectionData.result_image) {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'mb-2';
                
                const img = document.createElement('img');
                img.className = 'img-thumbnail';
                img.style.maxWidth = '400px';
                img.style.maxHeight = '300px';
                img.src = detectionData.result_image;
                img.alt = 'æ£€æµ‹ç»“æœå›¾ç‰‡';
                
                imageDiv.appendChild(img);
                messageContent.appendChild(imageDiv);
            }
            
            // æ·»åŠ æ£€æµ‹ç»Ÿè®¡ä¿¡æ¯
            const statsDiv = document.createElement('div');
            statsDiv.className = 'detection-stats mb-2';
            statsDiv.innerHTML = `
                <small class="text-muted">
                    æ£€æµ‹åˆ° <strong>${detectionData.detections.length}</strong> ä¸ªä¸­è‰è¯å¯¹è±¡ï¼Œ
                    ç”¨æ—¶ <strong>${detectionData.elapsed_time.toFixed(2)}</strong> ç§’
                </small>
            `;
            messageContent.appendChild(statsDiv);
            
            // æ·»åŠ æ£€æµ‹è¯¦æƒ…åˆ—è¡¨
            if (detectionData.detections && detectionData.detections.length > 0) {
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'detection-details';
                
                const listDiv = document.createElement('div');
                listDiv.innerHTML = '<strong>è¯†åˆ«ç»“æœï¼š</strong>';
                
                const ul = document.createElement('ul');
                ul.className = 'list-unstyled mt-1';
                
                detectionData.detections.forEach((detection, index) => {
                    const li = document.createElement('li');
                    li.className = 'mb-1';
                    li.innerHTML = `
                        <span class="badge bg-primary me-2">${index + 1}</span>
                        <strong>${detection.class_name}</strong> 
                        <span class="text-muted">(ç½®ä¿¡åº¦: ${(detection.confidence * 100).toFixed(1)}%)</span>
                    `;
                    ul.appendChild(li);
                });
                
                detailsDiv.appendChild(listDiv);
                detailsDiv.appendChild(ul);
                messageContent.appendChild(detailsDiv);
            }
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.innerText = 'åˆšåˆš';
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageTime);
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // åŠ è½½å¯¹è¯åˆ—è¡¨
        function loadConversations() {
            fetch('/api/chat/conversations')
                .then(response => response.json())
                .then(conversations => {
                    // æ¸…ç©ºåˆ—è¡¨
                    conversationList.innerHTML = '';
                    
                    if (conversations.length === 0) {
                        noConversationsMessage.style.display = 'block';
                    } else {
                        noConversationsMessage.style.display = 'none';
                        
                        // æ’åºå¯¹è¯ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        conversations.sort((a, b) => b.updated_at - a.updated_at);
                        
                        conversations.forEach(conversation => {
                            const item = document.createElement('div');
                            item.className = 'conversation-item';
                            if (conversation.id === currentConversationId) {
                                item.classList.add('active');
                            }
                            
                            const title = document.createElement('div');
                            title.className = 'conversation-title';
                            title.innerText = conversation.title;
                            
                            const date = document.createElement('div');
                            date.className = 'conversation-date';
                            date.innerText = formatDate(conversation.updated_at);
                            
                            item.appendChild(title);
                            item.appendChild(date);
                            
                            item.addEventListener('click', function() {
                                loadConversation(conversation.id);
                            });
                            
                            conversationList.appendChild(item);
                        });
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
                });
        }
        
        // åŠ è½½ç‰¹å®šå¯¹è¯
        function loadConversation(conversationId) {
            fetch(`/api/chat/history/${conversationId}`)
                .then(response => response.json())
                .then(conversation => {
                    // è®¾ç½®å½“å‰å¯¹è¯ID
                    currentConversationId = conversationId;
                    
                    // æ¸…ç©ºèŠå¤©è®°å½•
                    chatHistory.innerHTML = '';
                    
                    // æ·»åŠ æ¶ˆæ¯
                    conversation.messages.forEach(message => {
                        addMessage(message.content, message.role);
                    });
                    
                    // æ›´æ–°æ´»åŠ¨å¯¹è¯é¡¹
                    const items = document.querySelectorAll('.conversation-item');
                    items.forEach(item => {
                        item.classList.remove('active');
                        const title = item.querySelector('.conversation-title');
                        if (title.innerText === conversation.title) {
                            item.classList.add('active');
                        }
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error);
                });
        }
        
        // åˆ›å»ºæ–°å¯¹è¯
        function createNewConversation() {
            // é‡ç½®å½“å‰å¯¹è¯ID
            currentConversationId = null;
            
            // æ¸…ç©ºèŠå¤©è®°å½•
            chatHistory.innerHTML = '';
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            addMessage('æ‚¨å¥½ï¼æˆ‘æ˜¯ä¸­åŒ»è¯é—®ç­”ç§‘æ™®AIåŠ©æ‰‹ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ', 'assistant');
            
            // æ›´æ–°æ´»åŠ¨å¯¹è¯é¡¹
            const items = document.querySelectorAll('.conversation-item');
            items.forEach(item => {
                item.classList.remove('active');
            });
            
            // ç„¦ç‚¹åˆ°è¾“å…¥æ¡†
            messageInput.focus();
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            
            // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            // å¦‚æœæ˜¯ä»Šå¹´ï¼Œæ˜¾ç¤ºæœˆæ—¥å’Œæ—¶é—´
            if (date.getFullYear() === now.getFullYear()) {
                return date.toLocaleString([], {month: 'short', day: '2-digit'});
            }
            
            // å¦åˆ™æ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
            return date.toLocaleString([], {year: 'numeric', month: 'short', day: '2-digit'});
        }
    });
</script>
{% endblock %} 